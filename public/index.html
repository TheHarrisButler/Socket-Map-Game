<!DOCTYPE html>

<html>

    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Websocket Server</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
        <style>
            
        </style>
    </head>

    <body>
        <header class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-body border-bottom shadow-sm">
            <p class="h5 my-0 me-md-auto fw-normal">The Map Game</p>
            <nav class="d-inline-flex mt-2 mt-md-0 ms-md-auto">
                <a class="me-3 py-2 text-dark text-decoration-none" href="#">Instructions</a>
            </nav>
        </header>
        <main class="container py-2">
            <div class="p-5 mb-4 bg-light rounded-3">
                <div class="container-fluid py-5">

                </div>
            </div>
            <div class="row align-items-md-stretch">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Players</h5>
                            <div id="divPlayers"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Play</h5>
                            <button type='button' id='createBtn' class="btn btn-outline-primary">Create Game</button>
                            <p></p>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                  <button  id='joinBtn' class="btn btn-outline-primary" type="button">Join game</button>
                                </div>
                                <input type="text" id='txtgameId' class="form-control" placeholder="Game URL" aria-label="Game Link" aria-describedby="basic-addon1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <script>
            let clientId = null;
            let gameId = null;

            let ws = new WebSocket("ws://localhost:4000"); 
            const createBtn = document.getElementById("createBtn");
            const joinBtn = document.getElementById("joinBtn");
            const txtgameId = document.getElementById("txtgameId");
            const divPlayers = document.getElementById("divPlayers");

            //Wiring events
            joinBtn.addEventListener("click", e => {
                
                if (gameId === null)
                    gameId = txtgameId.value;

                const payLoad = {
                    "method": "join", 
                    "clientId": clientId,
                    "gameId": gameId,
                }

                ws.send(JSON.stringify(payLoad)); 
            });

            createBtn.addEventListener("click", e => {
                const payLoad = {
                    "method": "create", 
                    "clientId": clientId,
                }

                ws.send(JSON.stringify(payLoad)); 
            }); 

            ws.onmessage = message => { 
                //message.data
                const response = JSON.parse(message.data);
                //connect
                if (response.method === "connect") {
                    clientId = response.clientId; 
                    console.log("Client id set successful " + clientId);
                }

                if (response.method === "create") {
                    gameId = response.game.id;
                    console.log("Games successfully created with id " + gameId );
                }

                if (response.method === "join") {
                    const game = response.game;

                    while(divPlayers.firstChild)
                        divPlayers.removeChild(divPlayers.firstChild); 

                    game.clients.forEach(c => {
                        const d = document.createElement("div");
                        d.style.width = "200px"; 
                        d.style.background = c.color; 
                        d.textContent = c.clientId; 
                        divPlayers.appendChild(d); 
                    })
                }
            }
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
    </body>
</html>