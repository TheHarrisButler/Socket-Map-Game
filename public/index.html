<!DOCTYPE html>

<html>

    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>The Map Game</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
        <style>
            #street-view {
                height: 400px;
            }
        </style>
    </head>

    <body>
        <header>
            <div class="collapse bg-dark" id="navbarHeader">
              <div class="container">
                <div class="row">
                  <div class="col-sm-8 col-md-7 py-4">
                    <h4 class="text-white">Play</h4>
                    <button type='button' id='createBtn' class="btn btn-outline-primary">Create Game</button>
                    <p></p>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <button  id='joinBtn' class="btn btn-outline-primary" type="button">Join game</button>
                        </div>
                        <input type="text" id='txtgameId' class="form-control" placeholder="Game URL" aria-label="Game Link" aria-describedby="basic-addon1">
                    </div>
                  </div>
                  <div class="col-sm-4 offset-md-1 py-4">
                    <h4 class="text-white">Learn More</h4>
                    <ul class="list-unstyled">
                      <li><a href="#" class="text-white">Instructions</a></li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            <div class="navbar navbar-dark bg-dark shadow-sm">
              <div class="container">
                <a href="#" class="navbar-brand d-flex align-items-center">
                  <strong>The Map Game</strong>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarHeader" aria-controls="navbarHeader" aria-expanded="false" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon"></span>
                </button>
              </div>
            </div>
        </header>
        <main class="container py-2">
            <div class="p-5 mb-4 bg-light rounded-3">
                <div class="p-1 mb-4 bg-light rounded-3">
                    <div id="divAlert"></div>
                    <div class="container-fluid ">
                        <div id="street-view"></div>
                        <p></p>
                        <div class="form-group">
                            <label for="state" class="col-sm-2 control-label">Guess the State</label>
                            <div>
                                <select class="form-control" id="guessInput" name="state">
                                    <option value="AK">Alaska</option>
                                    <option value="AL">Alabama</option>
                                    <option value="AR">Arkansas</option>
                                    <option value="AZ">Arizona</option>
                                    <option value="CA">California</option>
                                    <option value="CO">Colorado</option>
                                    <option value="CT">Connecticut</option>
                                    <option value="DC">District of Columbia</option>
                                    <option value="DE">Delaware</option>
                                    <option value="FL">Florida</option>
                                    <option value="GA">Georgia</option>
                                    <option value="HI">Hawaii</option>
                                    <option value="IA">Iowa</option>
                                    <option value="ID">Idaho</option>
                                    <option value="IL">Illinois</option>
                                    <option value="IN">Indiana</option>
                                    <option value="KS">Kansas</option>
                                    <option value="KY">Kentucky</option>
                                    <option value="LA">Louisiana</option>
                                    <option value="MA">Massachusetts</option>
                                    <option value="MD">Maryland</option>
                                    <option value="ME">Maine</option>
                                    <option value="MI">Michigan</option>
                                    <option value="MN">Minnesota</option>
                                    <option value="MO">Missouri</option>
                                    <option value="MS">Mississippi</option>
                                    <option value="MT">Montana</option>
                                    <option value="NC">North Carolina</option>
                                    <option value="ND">North Dakota</option>
                                    <option value="NE">Nebraska</option>
                                    <option value="NH">New Hampshire</option>
                                    <option value="NJ">New Jersey</option>
                                    <option value="NM">New Mexico</option>
                                    <option value="NV">Nevada</option>
                                    <option value="NY">New York</option>
                                    <option value="OH">Ohio</option>
                                    <option value="OK">Oklahoma</option>
                                    <option value="OR">Oregon</option>
                                    <option value="PA">Pennsylvania</option>
                                    <option value="RI">Rhode Island</option>
                                    <option value="SC">South Carolina</option>
                                    <option value="SD">South Dakota</option>
                                    <option value="TN">Tennessee</option>
                                    <option value="TX">Texas</option>
                                    <option value="UT">Utah</option>
                                    <option value="VA">Virginia</option>
                                    <option value="VT">Vermont</option>
                                    <option value="WA">Washington</option>
                                    <option value="WI">Wisconsin</option>
                                    <option value="WV">West Virginia</option>
                                    <option value="WY">Wyoming</option>
                                </select>
                            </div>
                            <p></p>
                            <button type="button" id="guessBtn" class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row align-items-md-stretch">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Players</h5>
                            <div id="divPlayers"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Address</h5>
                            <form>
                                <div class="form-group">
                                  <label>Street</label>
                                  <input type="text" class="form-control" id="streetInput"  placeholder="Enter street address">
                                </div>
                                <div class="form-group">
                                    <label>City</label>
                                    <input type="text" class="form-control" id="cityInput" placeholder="City">
                                  </div>
                                  <div class="form-group">
                                    <label for="state" class="col-sm-2 control-label">State</label>
                                    <div>
                                        <select class="form-control" id="stateInput" name="state">
                                            <option value="AK">Alaska</option>
                                            <option value="AL">Alabama</option>
                                            <option value="AR">Arkansas</option>
                                            <option value="AZ">Arizona</option>
                                            <option value="CA">California</option>
                                            <option value="CO">Colorado</option>
                                            <option value="CT">Connecticut</option>
                                            <option value="DC">District of Columbia</option>
                                            <option value="DE">Delaware</option>
                                            <option value="FL">Florida</option>
                                            <option value="GA">Georgia</option>
                                            <option value="HI">Hawaii</option>
                                            <option value="IA">Iowa</option>
                                            <option value="ID">Idaho</option>
                                            <option value="IL">Illinois</option>
                                            <option value="IN">Indiana</option>
                                            <option value="KS">Kansas</option>
                                            <option value="KY">Kentucky</option>
                                            <option value="LA">Louisiana</option>
                                            <option value="MA">Massachusetts</option>
                                            <option value="MD">Maryland</option>
                                            <option value="ME">Maine</option>
                                            <option value="MI">Michigan</option>
                                            <option value="MN">Minnesota</option>
                                            <option value="MO">Missouri</option>
                                            <option value="MS">Mississippi</option>
                                            <option value="MT">Montana</option>
                                            <option value="NC">North Carolina</option>
                                            <option value="ND">North Dakota</option>
                                            <option value="NE">Nebraska</option>
                                            <option value="NH">New Hampshire</option>
                                            <option value="NJ">New Jersey</option>
                                            <option value="NM">New Mexico</option>
                                            <option value="NV">Nevada</option>
                                            <option value="NY">New York</option>
                                            <option value="OH">Ohio</option>
                                            <option value="OK">Oklahoma</option>
                                            <option value="OR">Oregon</option>
                                            <option value="PA">Pennsylvania</option>
                                            <option value="RI">Rhode Island</option>
                                            <option value="SC">South Carolina</option>
                                            <option value="SD">South Dakota</option>
                                            <option value="TN">Tennessee</option>
                                            <option value="TX">Texas</option>
                                            <option value="UT">Utah</option>
                                            <option value="VA">Virginia</option>
                                            <option value="VT">Vermont</option>
                                            <option value="WA">Washington</option>
                                            <option value="WI">Wisconsin</option>
                                            <option value="WV">West Virginia</option>
                                            <option value="WY">Wyoming</option>
                                        </select>
                                    </div>
                                </div>
                                <p></p>
                                <button type="button" id="addressBtn" class="btn btn-primary">Submit</button>
                              </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <script>
            let clientId = null;
            let gameId = null;
            let lat = 37.86926;
            let lng = -122.254811;
            let myTurn = true;

            let ws = new WebSocket("ws://localhost:4000"); 
            const createBtn = document.getElementById("createBtn");
            const joinBtn = document.getElementById("joinBtn");
            const txtgameId = document.getElementById("txtgameId");
            const divPlayers = document.getElementById("divPlayers");
            const divAlert = document.getElementById("divAlert");
            const streetInput = document.getElementById("streetInput");
            const cityInput = document.getElementById("cityInput");
            const stateInput = document.getElementById("stateInput");
            const addressBtn = document.getElementById("addressBtn");
            const guessInput = document.getElementById("guessInput"); 
            const guessBtn = document.getElementById("guessBtn");

            function initialize() {
                panorama = new google.maps.StreetViewPanorama(
                    document.getElementById("street-view"),
                    {
                    position: { lat: lat, lng: lng },
                    disableDefaultUI: true,
                    pov: { heading: 165, pitch: 0 },
                    zoom: 1,
                    }
                );
            }

            function alert(n) {
                const d  = document.createElement("div");
                    d.className = "alert alert-warning alert-dismissible fade show"; 
                    d.textContent = n;
                    divAlert.appendChild(d);
                    sleep(2000); 
                    divAlert.removeChild(d);
            }

            //Wiring events
            joinBtn.addEventListener("click", e => {
                if (gameId === null)
                    gameId = txtgameId.value;

                const payLoad = {
                    "method": "join", 
                    "clientId": clientId,
                    "gameId": gameId,
                }

                ws.send(JSON.stringify(payLoad)); 
                
            });

            createBtn.addEventListener("click", e => {
                myTurn = false;
                const payLoad = {
                    "method": "create", 
                    "clientId": clientId,
                }

                ws.send(JSON.stringify(payLoad)); 
            });
            
            addressBtn.addEventListener("click", e => {
                if (gameId === null) {
                    alert("Game has not been created");
                }
                else if (myTurn === true) {
                    alert("It is your turn to guess not submitt an address!"); 
                }
                else{
                    const payLoad = {
                    "method": "set",
                    "gameId": gameId, 
                    "clientId": clientId,
                    "street": streetInput.value,
                    "city": cityInput.value, 
                    "state": stateInput.value, 
                    }

                    ws.send(JSON.stringify(payLoad)); 
                }
            });
            
            guessBtn.addEventListener("click", e => {
                if (gameId === null) {
                    alert("Game has not been created");
                }
                else if (myTurn === false) {
                    alert("It is not your turn to guess...please submit an address"); 
                }
                else{
                    const payLoad = {
                        "method" : "guess",
                        "gameId": gameId, 
                        "clientId": clientId, 
                        "guess": guessInput.value
                    }

                    ws.send(JSON.stringify(payLoad));
                }
            }); 

            ws.onmessage = message => { 
                //message.data
                const response = JSON.parse(message.data);
                //connect
                if (response.method === "connect") {
                    clientId = response.clientId; 
                    console.log("Client id set successful " + clientId);
                }

                if (response.method === "create") {
                    gameId = response.game.id;
                    console.log("Games successfully created with id " + gameId );
                }

                if (response.method === "join") {
                    const game = response.game;

                    while(divPlayers.firstChild)
                        divPlayers.removeChild(divPlayers.firstChild); 

                    game.clients.forEach(c => {
                        const d = document.createElement("div");
                        d.style.width = "200px"; 
                        d.style.background = c.color; 
                        d.textContent = c.name + " " + c.score; 
                        divPlayers.appendChild(d); 
                    })
                }

                if (response.method === "set") {
                    const game = response.game;
                    lat = response.lat; 
                    lng = response.lng; 

                    initialize();
                }

                if (response.method === "guess"){
                    const message = response.message;
                    const game = response.game;

                    if (message === "Correct!") {
                        const d  = document.createElement("div");
                        d.className = "alert alert-success alert-dismissible fade show"; 
                        d.textContent = "The player guessed correctly";
                        divAlert.appendChild(d);
                        sleep(2000); 
                        divAlert.removeChild(d);
                    }else{
                        const d  = document.createElement("div");
                        d.className = "alert alert-danger alert-dismissible fade show"; 
                        d.textContent = "The player guessed incorrectly";
                        divAlert.appendChild(d);
                        sleep(2000); 
                        divAlert.removeChild(d); 
                    }

                    while(divPlayers.firstChild)
                        divPlayers.removeChild(divPlayers.firstChild); 

                    game.clients.forEach(c => {
                        const d = document.createElement("div");
                        d.style.width = "200px"; 
                        d.style.background = c.color; 
                        d.textContent = c.name + " " + c.score; 
                        divPlayers.appendChild(d); 
                    });
                }
            }
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA0f-uBcsgu1PQh0i6wdxe3FDSsgUo63_k&callback=initialize&libraries=&v=weekly" async ></script>
    </body>
</html>